---
title: "Confounding Simulations"
author: "Eleanor Sanderson"
date: "03/08/2022"
output:
  html_document:
    df_print: paged
  pdf_document:
    keep_tex: yes
---


Combine all the data to generate the plots into one dataset that specifies %forC and steiger (Y/N)
Then use facet grid to make one nice plot with all of the results in. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Note;
Files should be saved as results.Rda before running this file. If results are still in the output given by the BC4 array job run 'combiningfiles.R' first.

```{r, include=FALSE}
library(tidyverse)
library(ggplot2)
library(here)
```

##Load the results and divide them into the different groups needed for analysis
```{r}
load(here("code", "results.Rda"))

modelA <- subset.data.frame(res, res$model=="A")
modelA_0.5 <- subset.data.frame(modelA, modelA$pi == 0.5)
modelA_0.75 <- subset.data.frame(modelA, modelA$pi == 0.75)
modelA_1 <- subset.data.frame(modelA, modelA$pi == 1)

modelB <- subset.data.frame(res, res$model=="B")
modelB_0.5 <- subset.data.frame(modelB, modelB$pi == 0.5)
modelB_0.75 <- subset.data.frame(modelB, modelB$pi == 0.75)
modelB_1 <- subset.data.frame(modelB, modelB$pi == 1)

modelC <- subset.data.frame(res, res$model=="C")
modelC_0.5 <- subset.data.frame(modelC, modelC$pi == 0.5)
modelC_0.75 <- subset.data.frame(modelC, modelC$pi == 0.75)
modelC_1 <- subset.data.frame(modelC, modelC$pi == 1)


plotcolours <-  c("Linear Regression" = "red3", "IVW" = "blue3", "MR Egger" = "green4", "W. Median" = "darkorchid", "W. Mode" = "darkorange", "MVMR" = "darkgoldenrod1")
desired_order <- c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR")
```

\section{Simulation results for where confounder is less strongly predicted than exposure}


\subsection{Generate figure for model A}

```{r}

resa_mean <- modelA_0.5 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)

resa_fig1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig1) <- c('pvalue',  'beta', 'se')
resa_fig1$Estimator <- "Linear Regression"


resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"


resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"

resa_mvmr <- resa_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resa_mvmr) <- c('pvalue', 'beta', 'se')
resa_mvmr$Estimator <- "MVMR"


resa_fig1 <- bind_rows(resa_fig1, resa_ivw, resa_egger, resa_med, resa_mode, resa_mvmr)
resa_fig1$Estimator <- factor(resa_fig1$Estimator, levels = desired_order)
resa_fig1$Steiger <- "No"
resa_fig1$PropC <- "50%"

plot1 <- ggplot(resa_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   ylim(-0.4, 0.2) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA0.5.pdf", width = 6.5, height = 5)

```
Generate results table

```{r}

tablea1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablea1$NSNPS <- 200

```

\subsection{Generate figure for model A - with steiger filtering applied}

```{r}

resa_fig2 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig2) <- c('pvalue',  'beta', 'se')
resa_fig2$Estimator <- "Linear Regression"



resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"

resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"


resa_fig2 <- bind_rows(resa_fig2, resa_ivw, resa_egger, resa_med, resa_mode)

# Convert Estimator to a factor with desired order of levels
resa_fig2$Estimator <- factor(resa_fig2$Estimator, levels = desired_order)
resa_fig2$Steiger <- "Yes"
resa_fig2$PropC <- "50%"

plot1 <- ggplot(resa_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   ylim(-0.4, 0.2) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA0.5_steiger.pdf")

```

Generate results table

```{r}

tablea1s <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablea1s$NSNPS <- 200

```


\section{Model B}
    
\subsection{Plot the distribution of the estimated parameters}

\subsection{Generate figure for model B}

```{r}

resb_mean <- modelB_0.5 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)


resb_fig1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 

colnames(resb_fig1) <- c('pvalue', 'beta', 'se')
resb_fig1$Estimator <- "Linear Regression"


resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"

resb_mvmr <- resb_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resb_mvmr) <- c('pvalue', 'beta', 'se')
resb_mvmr$Estimator <- "MVMR"


resb_fig1 <- bind_rows(resb_fig1, resb_ivw, resb_egger, resb_med, resb_mode, resb_mvmr)
resb_fig1$Estimator <- as.factor(resb_fig1$Estimator)
resb_fig1$Estimator <- factor(resb_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resb_fig1$Steiger <- "No"
resb_fig1$PropC <- "75%"


plot1 <- ggplot(resb_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB0.5.pdf")

```

Generate results table

```{r}

tableb1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tableb1$NSNPS <- 300

```


\subsection{Generate figure for model B - with steiger filtering applied}

```{r}

resb_fig2 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resb_fig2) <- c('pvalue', 'beta', 'se')
resb_fig2$Estimator <- "Linear Regression"

resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"


resb_fig2 <- bind_rows(resb_fig2, resb_ivw, resb_egger, resb_med, resb_mode)
resb_fig2$Estimator <- factor(resa_fig2$Estimator, levels = desired_order)
resb_fig2$Steiger <- "Yes"
resb_fig2$PropC <- "75%"

plot1 <- ggplot(resb_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB0.5_steiger.pdf")

```

Generate results table

```{r}

tableb1s <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tableb1s$NSNPS <- 300

```


\section{Model C}
    
\subsection{Generate figure for model C}

```{r}

resc_mean <- modelC_0.5 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)


resc_fig1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_b)) 
colnames(resc_fig1) <- c('pvalue', 'beta', 'se')
resc_fig1$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"

resc_mvmr <- resc_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resc_mvmr) <- c('pvalue', 'beta', 'se')
resc_mvmr$Estimator <- "MVMR"


resc_fig1 <- bind_rows(resc_fig1, resc_ivw, resc_egger, resc_med, resc_mode, resc_mvmr)
resc_fig1$Estimator <- as.factor(resc_fig1$Estimator)
resc_fig1$Estimator <- factor(resc_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resc_fig1$Steiger <- "No"
resc_fig1$PropC <- "87.5%"

plot1 <- ggplot(resc_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC0.5.pdf")

```

Generate results table

```{r}

tablec1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablec1$NSNPS <- 350

```


\subsection{Generate figure for model C - with steiger filtering}

```{r}

resc_fig2 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resc_fig2) <- c('pvalue', 'beta', 'se')
resc_fig2$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"


resc_fig2 <- bind_rows(resc_fig2, resc_ivw, resc_egger, resc_med, resc_mode)
resc_fig2$Estimator <- as.factor(resc_fig2$Estimator)
resc_fig2$Estimator <- factor(resc_fig2$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode"))
resc_fig2$Steiger <- "Yes"
resc_fig2$PropC <- "87.5%"

plot1 <- ggplot(resc_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC0.5_steiger.pdf")

```

Generate results table

```{r}

tablec1s <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablec1s$NSNPS <- 350

```


Calculating the number of repetitions used for each of the estimators in the plot above

```{r}

res_cforna <- modelC_0.5 %>% 
  select(pvalue, beta_ivw.s, beta_egger.s, beta_mode.s, beta_med.s)

na04 <- colSums(is.na(subset(res_cforna, pvalue==5e-04))) 
na06 <- colSums(is.na(subset(res_cforna, pvalue==5e-06))) 
na08 <- colSums(is.na(subset(res_cforna, pvalue==5e-08))) 
na12 <- colSums(is.na(subset(res_cforna, pvalue==5e-12))) 


```

Pvalue 5e-04
```{r}
na04
```
Pvalue 5e-06
```{r}
na06
```
Pvalue 5e-08
```{r}
na08
```
Pvalue 5e-12
```{r}
na12
```


Combining the tables and outputting them

```{r}
Table_all <- bind_rows(tablea1, tableb1, tablec1)
Table_steiger <- bind_rows(tablea1s, tableb1s, tablec1s)

write.csv(Table_all, "simresults_table_0.5.csv")
write.csv(Table_steiger, "simresults_steiger_0.5.csv")
```



```{r}
plot_dat0.5 <- rbind(resa_fig1, resa_fig2, resb_fig1, resb_fig2, resc_fig1, resc_fig2)

plot1 <- ggplot(plot_dat0.5, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  coord_cartesian(ylim = c(-0.75, 0.5)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure") +
  facet_grid(Steiger ~ PropC)

ggsave("plotcombined0.5.pdf")

```
\section{Simulation results for where pi = 0.75}


```{r}

resa_mean <- modelA_0.75 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)

resa_fig1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig1) <- c('pvalue',  'beta', 'se')
resa_fig1$Estimator <- "Linear Regression"


resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"


resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"

resa_mvmr <- resa_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resa_mvmr) <- c('pvalue', 'beta', 'se')
resa_mvmr$Estimator <- "MVMR"


resa_fig1 <- bind_rows(resa_fig1, resa_ivw, resa_egger, resa_med, resa_mode, resa_mvmr)
resa_fig1$Estimator <- as.factor(resa_fig1$Estimator)
resa_fig1$Estimator <- factor(resa_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resa_fig1$Steiger <- "No"
resa_fig1$PropC <- "50%"

plot1 <- ggplot(resa_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA0.75.pdf", width = 6.5, height = 5)

```
Generate results table

```{r}

tablea1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablea1$NSNPS <- 200

```

\subsection{Generate figure for model A - with steiger filtering applied}

```{r}

resa_fig2 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig2) <- c('pvalue',  'beta', 'se')
resa_fig2$Estimator <- "Linear Regression"



resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"

resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"


resa_fig2 <- bind_rows(resa_fig2, resa_ivw, resa_egger, resa_med, resa_mode)
resa_fig2$Estimator <- factor(resa_fig2$Estimator, levels = desired_order)
resa_fig2$Steiger <- "Yes"
resa_fig2$PropC <- "50%"

plot1 <- ggplot(resa_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   ylim(-0.4, 0.2) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA0.75_steiger.pdf")

```

Generate results table

```{r}

tablea1s <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablea1s$NSNPS <- 200

```


\section{Model B}
    
\subsection{Plot the distribution of the estimated parameters}

\subsection{Generate figure for model B}

```{r}

resb_mean <- modelB_0.75 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)


resb_fig1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 

colnames(resb_fig1) <- c('pvalue', 'beta', 'se')
resb_fig1$Estimator <- "Linear Regression"


resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"

resb_mvmr <- resb_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resb_mvmr) <- c('pvalue', 'beta', 'se')
resb_mvmr$Estimator <- "MVMR"


resb_fig1 <- bind_rows(resb_fig1, resb_ivw, resb_egger, resb_med, resb_mode, resb_mvmr)
resb_fig1$Estimator <- as.factor(resb_fig1$Estimator)
resb_fig1$Estimator <- factor(resb_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resb_fig1$Steiger <- "No"
resb_fig1$PropC <- "75%"

plot1 <- ggplot(resb_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB0.75.pdf")

```

Generate results table

```{r}

tableb1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tableb1$NSNPS <- 300

```


\subsection{Generate figure for model B - with steiger filtering applied}

```{r}

resb_fig2 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resb_fig2) <- c('pvalue', 'beta', 'se')
resb_fig2$Estimator <- "Linear Regression"

resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"


resb_fig2 <- bind_rows(resb_fig2, resb_ivw, resb_egger, resb_med, resb_mode)
resb_fig2$Estimator <- factor(resb_fig2$Estimator, levels = desired_order)
resb_fig2$Steiger <- "Yes"
resb_fig2$PropC <- "75%"

plot1 <- ggplot(resb_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB0.75_steiger.pdf")

```

Generate results table

```{r}

tableb1s <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tableb1s$NSNPS <- 300

```


\section{Model C}
    
\subsection{Generate figure for model C}

```{r}

resc_mean <- modelC_0.75 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean,  na.rm = TRUE)


resc_fig1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resc_fig1) <- c('pvalue', 'beta', 'se')
resc_fig1$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"

resc_mvmr <- resc_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resc_mvmr) <- c('pvalue', 'beta', 'se')
resc_mvmr$Estimator <- "MVMR"


resc_fig1 <- bind_rows(resc_fig1, resc_ivw, resc_egger, resc_med, resc_mode, resc_mvmr)
resc_fig1$Estimator <- as.factor(resc_fig1$Estimator)
resc_fig1$Estimator <- factor(resc_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resc_fig1$Steiger <- "No"
resc_fig1$PropC <- "87.5%"

plot1 <- ggplot(resc_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
     scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC0.75.pdf")

```

Generate results table

```{r}

tablec1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablec1$NSNPS <- 350

```


\subsection{Generate figure for model C - with steiger filtering}

```{r}

resc_fig2 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resc_fig2) <- c('pvalue', 'beta', 'se')
resc_fig2$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"


resc_fig2 <- bind_rows(resc_fig2, resc_ivw, resc_egger, resc_med, resc_mode)
resc_fig2$Estimator <- as.factor(resc_fig2$Estimator)
resc_fig2$Estimator <- factor(resc_fig2$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode"))
resc_fig2$Steiger <- "Yes"
resc_fig2$PropC <- "87.5%"


plot1 <- ggplot(resc_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC0.75_steiger.pdf")

```

Generate results table

```{r}

tablec1s <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablec1s$NSNPS <- 350

```


Calculating the number of repetitions used for each of the estimators in the plot above

```{r}

res_cforna <- modelC_0.75 %>% 
  select(pvalue, beta_ivw.s, beta_egger.s, beta_mode.s, beta_med.s)

na04 <- colSums(is.na(subset(res_cforna, pvalue==5e-04))) 
na06 <- colSums(is.na(subset(res_cforna, pvalue==5e-06))) 
na08 <- colSums(is.na(subset(res_cforna, pvalue==5e-08))) 
na12 <- colSums(is.na(subset(res_cforna, pvalue==5e-12))) 


```

Pvalue 5e-04
```{r}
na04
```
Pvalue 5e-06
```{r}
na06
```
Pvalue 5e-08
```{r}
na08
```
Pvalue 5e-12
```{r}
na12
```


Combining the tables and outputting them

```{r}
Table_all <- bind_rows(tablea1, tableb1, tablec1)
Table_steiger <- bind_rows(tablea1s, tableb1s, tablec1s)

write.csv(Table_all, "simresults_table_0.75.csv")
write.csv(Table_steiger, "simresults_steiger_0.75.csv")
```




```{r}
plot_dat0.75 <- rbind(resa_fig1, resa_fig2, resb_fig1, resb_fig2, resc_fig1, resc_fig2)

plot1 <- ggplot(plot_dat0.75, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  coord_cartesian(ylim = c(-0.5, 0.6)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure") +
  facet_grid(Steiger ~ PropC)

ggsave("plotcombined0.75.pdf")

```



  
\section{Simulation results for where confounder as strongly predicted as the exposure}


\subsection{Generate figure for model A}

```{r}


resa_mean <- modelA_1 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)

resa_fig1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig1) <- c('pvalue',  'beta', 'se')
resa_fig1$Estimator <- "Linear Regression"


resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"


resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"

resa_mvmr <- resa_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resa_mvmr) <- c('pvalue', 'beta', 'se')
resa_mvmr$Estimator <- "MVMR"


resa_fig1 <- bind_rows(resa_fig1, resa_ivw, resa_egger, resa_med, resa_mode, resa_mvmr)
resa_fig1$Estimator <- as.factor(resa_fig1$Estimator)
resa_fig1$Estimator <- factor(resa_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resa_fig1$Steiger <- "No"
resa_fig1$PropC <- "50%"

plot1 <- ggplot(resa_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA1.pdf", width = 6.5, height = 5)

```
Generate results table

```{r}

tablea1 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablea1$NSNPS <- 200

```

\subsection{Generate figure for model A - with steiger filtering applied}

```{r}

resa_fig2 <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resa_fig2) <- c('pvalue',  'beta', 'se')
resa_fig2$Estimator <- "Linear Regression"



resa_ivw <- resa_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resa_ivw) <- c('pvalue', 'beta', 'se')
resa_ivw$Estimator <- "IVW"

resa_egger <- resa_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resa_egger) <- c('pvalue', 'beta', 'se')
resa_egger$Estimator <- "MR Egger"

resa_med <- resa_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resa_med) <- c('pvalue', 'beta', 'se')
resa_med$Estimator <- "W. Median"

resa_mode <- resa_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resa_mode) <- c('pvalue', 'beta', 'se')
resa_mode$Estimator <- "W. Mode"


resa_fig2 <- bind_rows(resa_fig2, resa_ivw, resa_egger, resa_med, resa_mode)
resa_fig2$Estimator <- factor(resa_fig2$Estimator, levels = desired_order)
resa_fig2$Steiger <- "Yes"
resa_fig2$PropC <- "50%"


plot1 <- ggplot(resa_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   ylim(-0.4, 0.2) +
  scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelA1_steiger.pdf")

```

Generate results table

```{r}

tablea1s <- resa_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablea1s$NSNPS <- 200

```


\section{Model B}
    
\subsection{Plot the distribution of the estimated parameters}

\subsection{Generate figure for model B}

```{r}

resb_mean <- modelB_1 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean)


resb_fig1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 

colnames(resb_fig1) <- c('pvalue', 'beta', 'se')
resb_fig1$Estimator <- "Linear Regression"


resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"

resb_mvmr <- resb_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resb_mvmr) <- c('pvalue', 'beta', 'se')
resb_mvmr$Estimator <- "MVMR"


resb_fig1 <- bind_rows(resb_fig1, resb_ivw, resb_egger, resb_med, resb_mode, resb_mvmr)
resb_fig1$Estimator <- as.factor(resb_fig1$Estimator)
resb_fig1$Estimator <- factor(resb_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resb_fig1$Steiger <- "No"
resb_fig1$PropC <- "75%"


plot1 <- ggplot(resb_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB1.pdf")

```

Generate results table

```{r}

tableb1 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tableb1$NSNPS <- 300

```


\subsection{Generate figure for model B - with steiger filtering applied}

```{r}

resb_fig2 <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resb_fig2) <- c('pvalue', 'beta', 'se')
resb_fig2$Estimator <- "Linear Regression"

resb_ivw <- resb_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resb_ivw) <- c('pvalue', 'beta', 'se')
resb_ivw$Estimator <- "IVW"

resb_egger <- resb_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resb_egger) <- c('pvalue', 'beta', 'se')
resb_egger$Estimator <- "MR Egger"

resb_med <- resb_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resb_med) <- c('pvalue', 'beta', 'se')
resb_med$Estimator <- "W. Median"

resb_mode <- resb_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resb_mode) <- c('pvalue', 'beta', 'se')
resb_mode$Estimator <- "W. Mode"


resb_fig2 <- bind_rows(resb_fig2, resb_ivw, resb_egger, resb_med, resb_mode)
resb_fig2$Estimator <- factor(resa_fig2$Estimator, levels = desired_order)
resb_fig2$Steiger <- "Yes"
resb_fig2$PropC <- "75%"


plot1 <- ggplot(resb_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelB1_steiger.pdf")

```

Generate results table

```{r}

tableb1s <- resb_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tableb1s$NSNPS <- 300

```


\section{Model C}
    
\subsection{Generate figure for model C}

```{r}

resc_mean <- modelC_1 %>%
  select(-model) %>%
  group_by(pvalue) %>%
  summarise_all(mean, na.rm = TRUE)


resc_fig1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resc_fig1) <- c('pvalue', 'beta', 'se')
resc_fig1$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw, se_ivw)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger, se_egger)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med, se_med)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode, se_mode)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"

resc_mvmr <- resc_mean %>%
  select(c(pvalue, mvmr.X1_effect, mvmr.X1_se)) 
colnames(resc_mvmr) <- c('pvalue', 'beta', 'se')
resc_mvmr$Estimator <- "MVMR"


resc_fig1 <- bind_rows(resc_fig1, resc_ivw, resc_egger, resc_med, resc_mode, resc_mvmr)
resc_fig1$Estimator <- as.factor(resc_fig1$Estimator)
resc_fig1$Estimator <- factor(resc_fig1$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode", "MVMR"))
resc_fig1$Steiger <- "No"
resc_fig1$PropC <- "87.5%"


plot1 <- ggplot(resc_fig1, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
     scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC1.pdf")

```

Generate results table

```{r}

tablec1 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw, se_ivw, beta_egger, se_egger, beta_med, se_med, beta_mode, se_mode, mvmr.X1_effect, mvmr.X1_se)) 
  
tablec1$NSNPS <- 350

```


\subsection{Generate figure for model C - with steiger filtering}

```{r}

resc_fig2 <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se)) 
colnames(resc_fig2) <- c('pvalue', 'beta', 'se')
resc_fig2$Estimator <- "Linear Regression"

resc_ivw <- resc_mean %>%
  select(c(pvalue, beta_ivw.s, se_ivw.s)) 
colnames(resc_ivw) <- c('pvalue', 'beta', 'se')
resc_ivw$Estimator <- "IVW"

resc_egger <- resc_mean %>%
  select(c(pvalue, beta_egger.s, se_egger.s)) 
colnames(resc_egger) <- c('pvalue', 'beta', 'se')
resc_egger$Estimator <- "MR Egger"

resc_med <- resc_mean %>%
  select(c(pvalue, beta_med.s, se_med.s)) 
colnames(resc_med) <- c('pvalue', 'beta', 'se')
resc_med$Estimator <- "W. Median"

resc_mode <- resc_mean %>%
  select(c(pvalue, beta_mode.s, se_mode.s)) 
colnames(resc_mode) <- c('pvalue', 'beta', 'se')
resc_mode$Estimator <- "W. Mode"


resc_fig2 <- bind_rows(resc_fig2, resc_ivw, resc_egger, resc_med, resc_mode)
resc_fig2$Estimator <- as.factor(resc_fig2$Estimator)
resc_fig2$Estimator <- factor(resc_fig2$Estimator, levels = c("Linear Regression", "IVW", "MR Egger", "W. Median", "W. Mode"))
resc_fig2$Steiger <- "Yes"
resc_fig2$PropC <- "87.5%"

plot1 <- ggplot(resc_fig2, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
   scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure")

plot1
ggsave("plotmodelC1_steiger.pdf")

```

Generate results table

```{r}

tablec1s <- resc_mean %>%
  select(c(pvalue, ols_b, ols_se, beta_ivw.s, se_ivw.s, beta_egger.s, se_egger.s, beta_med.s, se_med.s, beta_mode.s, se_mode.s)) 
  
tablec1s$NSNPS <- 350

```


Calculating the number of repetitions used for each of the estimators in the plot above

```{r}

res_cforna <- modelC_1 %>% 
  select(pvalue, beta_ivw.s, beta_egger.s, beta_mode.s, beta_med.s)

na04 <- colSums(is.na(subset(res_cforna, pvalue==5e-04))) 
na06 <- colSums(is.na(subset(res_cforna, pvalue==5e-06))) 
na08 <- colSums(is.na(subset(res_cforna, pvalue==5e-08))) 
na12 <- colSums(is.na(subset(res_cforna, pvalue==5e-12))) 


```

Pvalue 5e-04
```{r}
na04
```
Pvalue 5e-06
```{r}
na06
```
Pvalue 5e-08
```{r}
na08
```
Pvalue 5e-12
```{r}
na12
```


Combining the tables and outputting them

```{r}
Table_all <- bind_rows(tablea1, tableb1, tablec1)
Table_steiger <- bind_rows(tablea1s, tableb1s, tablec1s)

write.csv(Table_all, "simresults_table_1.csv")
write.csv(Table_steiger, "simresults_steiger_1.csv")
```


```{r}
plot_dat1.0 <- rbind(resa_fig1, resa_fig2, resb_fig1, resb_fig2, resc_fig1, resc_fig2)

plot1 <- ggplot(plot_dat1.0, aes(x=log10(pvalue))) +
  geom_pointrange(aes(y=beta, ymin=(beta - 1.96*se), ymax=(beta + 1.96*se), group=Estimator, colour=Estimator), position=position_dodge(width = 0.5)) +
  coord_cartesian(ylim = c(-0.5, 0.6)) +
 scale_colour_manual(values = plotcolours) + 
   theme(legend.position = "bottom") +
  labs(x = "Pvalue (log10)", y = "Estimated effect of exposure") +
  facet_grid(Steiger ~ PropC)

ggsave("plotcombined1.0.pdf")

```
